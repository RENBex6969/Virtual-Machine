local FileSystem = require("@lune/fs")
local WebSocket = require("@lune/net").ws
local Serde = require("@lune/serde")
local Regex = require("@lune/regex")
local Task = require("@lune/task")
local Library = {}

assert(FileSystem.isFile("config.json"), "Default config.json is missing from the root directory!")
local ConfigJSON = FileSystem.readFile("config.json")

local Config = Serde.decode("json", ConfigJSON)

local function Userdata(): table
  local Out = newproxy(true)
  local Properties = getmetatable(Out)
  
  Properties.__index = {}
  
  Properties.__tostring = function()
    return "WebSocket"
  end
  
  return Out, Properties.__index
end

local function CreateEvent(CallbackTable : table): table
  local Handlers, Properties = Userdata()
  
  function Properties:Connect(Function)
    table.insert(CallbackTable, Function)
  end
  
  return Handlers
end

function Library.connect(Url : string): {}
  assert(type(Url) == "string", "websocket.connect: argument #1 to be a string, got " .. type(Url))

  local Url = Url:gsub("^%s+", ""):gsub("%s+$", "")

  local ReBase = Regex.new("^wss?://")
  if not ReBase:isMatch(Url) then
    Url = "wss://" .. Url
  end

  local ReBase = Regex.new("^wss://")
  if Config.Network.AlwaysWss and ReBase:isMatch(Url) then
    Url = ReBase:replace(Url, "wss://")
  end

  local WS = WebSocket.connect(Url)
  local Handlers, Properties = Userdata()
  Properties.Running = WS.send and true or false
  
  local Callback = {
    OnMessage = {},
    OnClose = {}
  }
  
  Properties.OnMessage = CreateEvent(Callback.OnMessage)
  Properties.OnClose = CreateEvent(Callback.OnClose)
  
  function Properties:Send(Message : string): nil
    local Succ, _ = pcall(WS.send, WS, Message)
    Properties.Running = Succ
  end
  
  function Properties:Close()
    Properties.Running = false
  end
  
  Task.spawn(function()
    while Properties.Running do
      local Message = WS:next()
      if Message then
        for _, Function in ipairs(Callback.OnMessage) do
          pcall(Function, Message)
        end
      else
        if WS.closeCode ~= nil then
          Properties.Running = false
            for _, Function in ipairs(Callbacks.OnClose) do
              pcall(Function, WS.closeCode)
            end
        end
      end
    end
  end)
  
  return Handlers
end

return Library