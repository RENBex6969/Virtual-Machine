local FileSystem = require("@lune/fs")
local Network = require("@lune/net")
local Serde = require("@lune/serde")
local Regex = require("@lune/regex")
local Library = {}

assert(FileSystem.isFile("config.json"), "Default config.json is missing from the root directory!")
local ConfigJSON = FileSystem.readFile("config.json")

local Config = Serde.decode("json", ConfigJSON)

local function request(Arguments : table): table
  assert(type(Arguments), "request: expected argument #1 to be a table, got " .. type(Arguments))
  assert(type(Arguments.Url == "string"), "request: expected argument #url to be a string, got" .. type(Arguments.Url))
  
  local Url = Arguments.Url:gsub("^%s+", ""):gsub("%s+$", "")
  
  local ReBase = Regex.new("^https?://")
  if not ReBase:isMatch(Url) then
    Url = "https://" .. Url
  end
  
  local ReBase = Regex.new("^http://")
  if Config.Network.AlwaysHttps and ReBase:isMatch(Url) then
    Url = ReBase:replace(Url, "https://")
  end
  
  local Method = Arguments.Method or "GET"
  local Headers = Config.Network.Headers
  
  local Body = nil
  if Arguments.Body ~= nil and Method ~= "GET" then
    Body = Serde.encode("json", Arguments.Body)
  end
  
  print("[REQUEST] " .. Url)
  
  local RequestData = {
    url = Url,
    method = Method,
    headers = Headers,
    body = Body
  }
  
  local Response = Network.request(RequestData)

  return {
    Body = Response.body,
    Headers = Response.headers,
    StatusCode = Response.statusCode,
    StatusMessage = Response.statusMessage
  }
end

function Library.HttpGet(Url : string): string
  assert(type(Url == "string"), "get: expected argument #1 to be a string, got " .. type(Url))
  return request({ 
    Url = Url
  }).Body
end

function Library.HttpPost(Url, Body)
  assert(type(Url == "string"), "post: expected argument #1 to be a string, got " .. type(Url))
  assert(type(Body == "table"), "post: expected argument #2 to be a table, got " .. type(Url))
  
  return request({
    Url = Url,
    Body = Body
  }).Body
end

function Library.Request(Arguments : table): table
  return request(Arguments)
end

return Library